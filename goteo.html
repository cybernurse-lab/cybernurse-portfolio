<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Goteo IV Pro | CyberNurse</title>
    
    <!-- Meta Tags para PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-title" content="Goteo Pro">

    <!-- Iconos Base64 -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232563eb'><path d='M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z' fill='%23eff6ff' stroke='%232563eb' stroke-width='2'/><path d='M12 6C12 6 16 11 16 14C16 16.2091 14.2091 18 12 18C9.79086 18 8 16.2091 8 14C8 11 12 6 12 6Z' fill='%233b82f6'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' style='background-color: %232563eb;'><rect width='24' height='24' fill='%232563eb'/><path d='M12 6C12 6 16 11 16 14C16 16.2091 14.2091 18 12 18C9.79086 18 8 16.2091 8 14C8 11 12 6 12 6Z' fill='white'/></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        blue: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        indigo: { 500: '#6366f1', 600: '#4f46e5' }
                    },
                    animation: { 
                        blob: "blob 7s infinite",
                    },
                    keyframes: {
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" },
                        }
                    },
                },
            },
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.6);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(219, 234, 254, 0.5);
        }
        .dark .glass-nav {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(30, 41, 59, 0.5);
        }
        
        @keyframes dropFall {
            0% { transform: translateY(0); opacity: 1; }
            85% { transform: translateY(70px) scale(1); opacity: 1; }
            95% { transform: translateY(75px) scale(1.3, 0.6); opacity: 1; }
            100% { transform: translateY(80px) scale(1); opacity: 0; }
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #3b82f6; margin-top: -10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #cbd5e1; border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #475569; }
    </style>
</head>
<body class="font-sans antialiased text-slate-900 bg-slate-50 dark:bg-slate-950 dark:text-white transition-colors duration-500 min-h-screen relative overflow-x-hidden pb-10">

    <div class="fixed inset-0 pointer-events-none -z-20 opacity-40 dark:opacity-20 overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-300 dark:bg-blue-900 rounded-full mix-blend-multiply filter blur-[100px] animate-blob"></div>
        <div class="absolute top-[40%] right-[-10%] w-[500px] h-[500px] bg-indigo-300 dark:bg-indigo-900 rounded-full mix-blend-multiply filter blur-[100px] animate-blob animation-delay-2000"></div>
    </div>

    <nav class="glass-nav sticky top-0 z-50 p-4 transition-all duration-300" id="navbar">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center text-sm font-bold text-slate-600 dark:text-slate-300 hover:text-blue-600 transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> Volver
            </a>
            <div class="flex items-center gap-3">
                <span class="text-sm font-bold text-blue-600 dark:text-blue-400">CyberNurse Tools</span>
                <button id="theme-toggle" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-blue-400 hover:text-blue-600 hover:bg-blue-100 dark:hover:bg-slate-700 transition-all shadow-sm">
                    <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-4 pt-6 space-y-6">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-extrabold text-slate-900 dark:text-white">Calculadora IV Pro</h1>
            <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider font-semibold">Simulador Clínico</p>
        </header>

        <!-- TARJETA 1: PLANIFICACIÓN -->
        <div class="glass-card rounded-3xl overflow-hidden shadow-lg">
            <div class="bg-blue-600 p-4 flex items-center justify-between">
                <h2 class="text-white font-bold flex items-center gap-2">
                    <i data-lucide="calculator" class="w-5 h-5"></i> Planificar Infusión
                </h2>
                <button type="button" id="btnClear" class="text-xs bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-full transition-colors font-medium">Limpiar</button>
            </div>
            
            <div class="p-6 space-y-5">
                <form id="calcForm" onsubmit="return false;" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">VOLUMEN TOTAL (ml)</label>
                        <input type="number" id="vol" placeholder="Ej: 1000" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 font-bold text-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-900 dark:text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">HORAS</label>
                            <input type="number" id="hrs" placeholder="8" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 font-bold text-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">MINUTOS</label>
                            <input type="number" id="mins" placeholder="0" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 font-bold text-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-slate-900 dark:text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">FACTOR GOTEO</label>
                        <div class="relative">
                            <select id="factor" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl pl-4 pr-10 py-3 font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer">
                                <option value="20">Macrogotero (20 gts/ml)</option>
                                <option value="60">Microgotero (60 gts/ml)</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-500 dark:text-slate-400">
                                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="btnCalculate" class="w-full bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/30 transition-all text-lg flex justify-center items-center gap-2">Calcular Ahora</button>
                </form>

                <div id="resultBox" class="hidden animate-in fade-in slide-in-from-top-4 duration-500 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-6">
                        <div class="flex-1 space-y-3">
                            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 border border-blue-100 dark:border-blue-800">
                                <span class="text-[10px] font-bold text-blue-500 uppercase">Velocidad</span>
                                <div class="text-2xl font-black text-blue-700 dark:text-blue-300" id="resMlH">0 <span class="text-sm font-medium text-blue-400">ml/h</span></div>
                            </div>
                            <div class="bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-3 border border-emerald-100 dark:border-emerald-800">
                                <span class="text-[10px] font-bold text-emerald-500 uppercase">Goteo</span>
                                <div class="text-3xl font-black text-emerald-600 dark:text-emerald-400" id="resGtsMin">0 <span class="text-sm font-medium text-emerald-400">gts/min</span></div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center justify-center w-24">
                            <div class="relative w-16 h-32 bg-slate-100 dark:bg-slate-800/50 rounded-full border-2 border-slate-200 dark:border-slate-700 flex items-center justify-center shadow-inner overflow-hidden">
                                <svg width="100%" height="100%" viewBox="0 0 40 100" class="absolute inset-0">
                                    <path d="M10,0 L30,0 L30,40 C30,55 10,55 10,40 Z" fill="none" stroke="#94a3b8" stroke-width="1.5" opacity="0.5"/>
                                    <path d="M12,35 Q20,38 28,35 L28,40 C28,50 12,50 12,40 Z" fill="#60a5fa" opacity="0.4"/>
                                    <path id="animDrop" d="M20,10 C20,10 24,15 24,19 C24,23 20,25 20,25 C20,25 16,23 16,19 C16,15 20,10 20,10 Z" fill="#3b82f6" class="opacity-0" />
                                </svg>
                            </div>
                            <span class="text-[10px] text-slate-400 mt-2 font-mono" id="animMs">-- ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TARJETA 2: VERIFICADOR MANUAL (AUDITORÍA) -->
        <div class="glass-card rounded-3xl overflow-hidden shadow-lg border-t-4 border-t-amber-500">
            <div class="p-6">
                <h2 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-1">
                    <i data-lucide="hand-metal" class="w-5 h-5 text-amber-500"></i> Verificador Manual
                </h2>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-6">Audita el goteo real al pie de cama.</p>

                <div class="flex flex-col items-center gap-6">
                    <!-- Gota Grande Manual -->
                    <div class="relative w-20 h-40 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border border-slate-200 dark:border-slate-700 shadow-inner overflow-hidden">
                         <svg width="100%" height="100%" viewBox="0 0 40 100" class="absolute inset-0">
                            <line x1="20" y1="0" x2="20" y2="10" stroke="#cbd5e1" stroke-width="2" />
                            <path id="manualDrop" d="M20,10 C20,10 25,16 25,21 C25,26 20,28 20,28 C20,28 15,26 15,21 C15,16 20,10 20,10 Z" fill="#f59e0b" class="opacity-0" />
                        </svg>
                    </div>

                    <!-- Resultados Manuales -->
                    <div class="text-center w-full">
                        <div class="flex flex-col items-center justify-center">
                            <div class="text-4xl font-black text-amber-500 leading-none" id="manualResult">--</div>
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Gts / Min</div>
                        </div>

                        <!-- NUEVA SECCIÓN: Estimación de Tiempo -->
                        <div class="mt-6 bg-amber-50 dark:bg-amber-900/10 rounded-xl p-4 border border-amber-100 dark:border-amber-800/30">
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] font-bold text-amber-700 dark:text-amber-400 uppercase text-left">Volumen Restante (ml)</label>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="manualVol" placeholder="Ej: 500" class="w-24 bg-white dark:bg-slate-800 border border-amber-200 dark:border-amber-800 rounded-lg px-3 py-2 text-sm font-bold text-slate-900 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none text-center">
                                    <div class="flex-1 text-left border-l border-amber-200 dark:border-amber-800 pl-3">
                                        <div class="text-[10px] text-slate-500 dark:text-slate-400 uppercase font-semibold">Termina en</div>
                                        <div class="text-xl font-black text-slate-800 dark:text-white leading-none mt-0.5" id="manualTime">-- h -- m</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="w-full space-y-4">
                        <div class="bg-slate-100 dark:bg-slate-800/50 rounded-xl p-3">
                            <input type="range" id="manualSlider" min="10" max="150" value="60" class="w-full cursor-pointer">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1">
                                <span>10</span><span>Ajuste Fino</span><span>150</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="tapBtn" class="bg-amber-500 hover:bg-amber-600 active:scale-95 text-white font-bold py-4 rounded-xl shadow-lg shadow-amber-500/30 transition-all flex flex-col items-center justify-center select-none">
                                <span class="text-lg">TAP</span><span class="text-[10px] opacity-80 font-normal">Marcar Gota</span>
                            </button>
                            <button id="btnResetManual" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-bold py-4 rounded-xl transition-all flex flex-col items-center justify-center">
                                <i data-lucide="rotate-ccw" class="w-5 h-5 mb-1"></i><span class="text-[10px]">Borrar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();

            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('navbar').style.display = 'none';
            }

            // --- LÓGICA CALCULADORA ---
            const btnCalculate = document.getElementById('btnCalculate');
            const btnClear = document.getElementById('btnClear');

            function calculate() {
                const vol = parseFloat(document.getElementById('vol').value);
                const hrs = parseFloat(document.getElementById('hrs').value || 0);
                const mins = parseFloat(document.getElementById('mins').value || 0);
                const factor = parseFloat(document.getElementById('factor').value);

                if (!vol || (hrs === 0 && mins === 0)) { alert("Por favor ingresa datos válidos."); return; }

                const totalHours = hrs + (mins / 60);
                const mlPerHour = vol / totalHours;
                const dropsPerMin = (vol * factor) / (totalHours * 60);

                document.getElementById('resMlH').innerHTML = `${mlPerHour.toFixed(1)} <span class="text-sm font-medium text-blue-400">ml/h</span>`;
                document.getElementById('resGtsMin').innerHTML = `${Math.round(dropsPerMin)} <span class="text-sm font-medium text-emerald-400">gts/min</span>`;
                document.getElementById('resultBox').classList.remove('hidden');

                const animDrop = document.getElementById('animDrop');
                const msPerDrop = 60000 / dropsPerMin;
                
                animDrop.style.animation = 'none'; 
                animDrop.offsetHeight; 
                const speed = Math.max(msPerDrop, 200);
                animDrop.style.animation = `dropFall ${speed}ms linear infinite`;
                
                document.getElementById('animMs').innerText = `Intervalo: ${Math.round(msPerDrop)}ms`;
            }

            function clearCalculator() {
                document.getElementById('calcForm').reset();
                document.getElementById('resultBox').classList.add('hidden');
                document.getElementById('animDrop').style.animation = 'none';
            }

            if (btnCalculate) btnCalculate.addEventListener('click', calculate);
            if (btnClear) btnClear.addEventListener('click', clearCalculator);


            // --- LÓGICA VERIFICADOR MANUAL & TIEMPO RESTANTE ---
            const manualSlider = document.getElementById('manualSlider');
            const manualDrop = document.getElementById('manualDrop');
            const manualResult = document.getElementById('manualResult');
            const tapBtn = document.getElementById('tapBtn');
            const btnResetManual = document.getElementById('btnResetManual');
            const manualVolInput = document.getElementById('manualVol');
            const manualTimeDisplay = document.getElementById('manualTime');
            let tapTimes = [];
            let currentManualGts = 60; // Valor inicial

            // Función centralizada para actualizar todo lo manual
            function updateManualUI(gtsMin) {
                currentManualGts = gtsMin;
                manualResult.innerText = Math.round(gtsMin);
                manualSlider.value = gtsMin;
                
                // Animación
                const ms = 60000 / gtsMin;
                manualDrop.style.animation = 'none'; 
                manualDrop.offsetHeight;
                manualDrop.style.animation = `dropFall ${ms}ms linear infinite`;

                // Calcular Tiempo Restante
                calculateRemainingTime();
            }

            function calculateRemainingTime() {
                const vol = parseFloat(manualVolInput.value);
                const factor = parseFloat(document.getElementById('factor').value); // Usa el factor seleccionado arriba
                const gtsMin = currentManualGts;

                if (vol > 0 && gtsMin > 0) {
                    // Formula: Tiempo(min) = (Volumen * Factor) / GtsMin
                    const totalMinutes = (vol * factor) / gtsMin;
                    
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = Math.round(totalMinutes % 60);
                    
                    manualTimeDisplay.innerText = `${hours}h ${minutes}m`;
                    manualTimeDisplay.classList.add('text-blue-600', 'dark:text-blue-400');
                } else {
                    manualTimeDisplay.innerText = "-- h -- m";
                    manualTimeDisplay.classList.remove('text-blue-600', 'dark:text-blue-400');
                }
            }

            // Listeners Manuales
            if (manualVolInput) manualVolInput.addEventListener('input', calculateRemainingTime);
            
            // Si cambian el factor arriba, también actualiza el cálculo de abajo
            document.getElementById('factor').addEventListener('change', calculateRemainingTime);

            if (manualSlider) {
                manualSlider.addEventListener('input', (e) => { 
                    updateManualUI(e.target.value);
                    tapTimes = []; 
                });
            }

            if (tapBtn) {
                tapBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    const now = Date.now();
                    if (tapTimes.length > 0 && (now - tapTimes[tapTimes.length - 1] > 2000)) { tapTimes = []; }
                    
                    tapTimes.push(now);
                    if (tapTimes.length > 5) tapTimes.shift();

                    if (tapTimes.length > 1) {
                        let intervals = [];
                        for(let i=1; i<tapTimes.length; i++) {
                            intervals.push(tapTimes[i] - tapTimes[i-1]);
                        }
                        const avgMs = intervals.reduce((a,b)=>a+b) / intervals.length;
                        const bpm = 60000 / avgMs;
                        updateManualUI(bpm);
                    }
                    
                    tapBtn.classList.add('bg-amber-700');
                    setTimeout(() => tapBtn.classList.remove('bg-amber-700'), 100);
                });
            }

            function resetManual() {
                tapTimes = []; 
                manualVolInput.value = "";
                manualTimeDisplay.innerText = "-- h -- m";
                manualResult.innerText = "--"; 
                manualDrop.style.animation = 'none'; 
                manualSlider.value = 60;
                currentManualGts = 0;
            }

            if (btnResetManual) btnResetManual.addEventListener('click', resetManual);


            // --- TEMA ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            function toggleTheme() {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark'); 
                    localStorage.theme = 'light';
                } else {
                    document.documentElement.classList.add('dark'); 
                    localStorage.theme = 'dark';
                }
            }

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);

            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            resetManual();
        });
    </script>
</body>
</html>
